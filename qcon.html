<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>JavaScript + Other Languages</title>

    <meta name="description" content="JavaScript + Other Languages">
    <meta name="author" content="Alon Zakai">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/sky.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

    <style type="text/css">
      h2 b {
        color: #048;
      }
      h3 b {
        color: #369;
      }
      b {
        color: #a39;
      }
    </style>

  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>
          <h2><b>JavaScript <div style="color: #c4b">+</div> Other<br>Languages</b></h2>
          <h3>Alon Zakai (Mozilla)</h3>
          <h3><b>QCon</b></h3>
        </section>

        <section>
          <h3><b>Other Languages?</b></h3>
          <p>Why? ;)</p>
        </section>

        <section>
          <h3><b>JavaScript is great</b></h3>
          <p>
            <ul>
              <li>Runs in all browsers</li>
              <li>Familiar syntax</li>
              <li>Dynamic typing</li>
            </ul>
           </p>
          <hr>
          <h3 class="fragment"><b>Other languages are great too</b></h3>
          <p>
            <ul>
              <li class="fragment">Existing code</li>
              <li class="fragment">Developer tools</li>
              <li class="fragment">Other forms of typing (static, etc.)</li>
            </ul>
           </p>
        </section>

        <section>
          <h3><b>Mixing Languages: examples</b></h3>
          <p>
            <ul>
              <li>Script languages in <b>spreadsheets</b> (C/C++ and VBA, etc.)</li>
              <li>Script languages in <b>web browsers</b> (C/C++ and JS)</li>
              <li>Script languages in <b>game engines</b> (C/C++ and Lua, etc.)</li>
              <li>High-performance <b>libraries for script languages</b> (Python and C/C++, etc.)</li>
            </ul>
          </p>
        </section>

        <section>
          <h3><b>Direct vs indirect connections</b></h3>
          <p>We are talking about <b>directly</b> connecting two languages: They run together in the same app.</p>
          <p>Also possible to <b>indirectly</b> connect them:
            <ul>
              <li>Two languages working separately but read the same database</li>
              <li>Two languages sending messages to each other (e.g., a web browser - C/C++ and JavaScript - communicating with a Ruby server)</li>
            </ul>
          </p>
        </section>


        <section>
          <h3><b>The Web</b></h3>
          <p class="fragment">JavaScript is the <b>only</b> standards-based language in web browsers</p>
          <p class="fragment">If we want to run other languages on the web, we need to go <b>through</b> JavaScript</p>
        </section>

        <section>
          <h3><b>Going through JavaScript</b></h3>
          <p>Might seem like an odd solution</p>
          <p class="fragment">But <b>replacing</b> JavaScript with anything else would slow down the web</p>
          <p class="fragment">Adding <b>another VM</b> alongside JavaScript is complicated (cross-VM GC, etc.)</p>
          <p class="fragment"><b>Consensus to standardize</b> any such change would be very hard</p>
        </section>

        <section>
          <h3><b>Going through JavaScript</b></h3>
          <p>It turns out to be <b>not</b> so odd a solution!</p>
          <p class="fragment">Running other languages in JavaScript <b>requires no standardization</b></p>
          <p class="fragment">Turns out <b>performance can be good</b> in many cases</p>
          <p class="fragment">No new VM means <b>no new security attack surface</b></p>
        </section>

        <section>
          <h3><b>1. Compile Code to JS</b></h3>
          <p>
            <ul>
              <li>C/C++: Emscripten, Mandreel</li>
              <li>Java: GWT</li>
              <li>C#: JSIL</li>
              <li>Python: pyjs</li>
              <li>Lua: lua.js</li>
              <li>..</li>
              <li><a href="https://github.com/jashkenas/coffee-script/wiki/List-of-languages-that-compile-to-JS">Jeremy Ashkenas's list</a> has many dozens</li>
            </ul>
          </p>
        </section>

        <section>
          <h3><b>Compiling to JavaScript:<br>Nothing New!</b></h3>
          <ul>
            <li>2006: <b>Google Web Toolkit (GWT)</b>, Java to JS</li>
            <li>2007: <b>pyjamas</b>, Python into JS</li>
          </ul>
        </section>

        <section>
          <h3><b>Adoption</b></h3>
          <ul>
            <li><b>Java (GWT)</b> used in <a href="http://www.blogger.com/">Blogger</a>, many enterprise apps</li>
            <li><b>C# (Script#)</b> used in <a href="http://office.microsoft.com/en-us/web-apps">Microsoft Office Web Apps</a></li>
          </ul>
        </section>

        <section>
          <h3><b>How Compilation Works</h3></b>
          <p>For example, in Emscripten:</p>
          <ul>
            <br>
            <p><b style="color: #085">C/C++</b> &nbsp <b>=></b> &nbsp <b style="color: #580">LLVM</b> &nbsp <b>=></b> &nbsp <b>Emscripten</b> &nbsp <b>=></b> &nbsp <b style="color: #058">JavaScript</b></p>
          </ul>
        </section>

        <section>
          <h3><b>Compilation Results</b></h3>
          <p>For example, this C++ code
          <pre><code contenteditable>  volatile float array[5000];
  int main() {
    for (int i = 0; i < 5000; ++i) {
      array[i] += 1.0f;
    }
  }</code></pre>
          <p>turns into this JavaScript code</p>
          <pre><code contenteditable>  function main() {
    var a = 0, b = 0;
    do {
      a = 8 + (b << 2) | 0;
      g[a >> 2] = +g[a >> 2] + 1.0;
      b = b + 1 | 0;
    } while ((b | 0) < 5000);
  }</code></pre>
          <p class="fragment">JavaScript, but a low-level subset of it called <b><a href="http://asmjs.org">asm.js</a></b></p>
        </section>

        <section>
          <h3><b>1. Compile Code to JS</b></h3>
          <p>..</p>
          <div class="fragment">
          <h3><b>2. Compile VMs to JS</b></h3>
          <p>Use a C/C++ to JavaScript compiler on the C/C++ Virtual Machine (VM) of a language</p>
          <p>Avoid writing a new VM or compiler for the language</p>
          </div>
        </section>

        <section>
          <h3><b>Demos: C++ w/ Emscripten</b></h3>
          <p><b><a href="epic/EpicCitadel.html">Epic Citadel</a></b></p>
          <p><b><a href="banana/benchmark.html">BananaBread</a></b></p>
          <p><b><a href="qt/QtDemo.html">Qt</a></b></p>
          <p><b><a href="lua/repl.html">Lua</a></b></p>
          <p><b><a href="xmlvm/index.html">Demo</a></b> using <a href="http://xmlvm.org/">XMLVM</a> and Emscripten</p>
          <a href="http://emscripten.org"><img src="emscripten_switch_logo.png" width="35%" style="position: absolute; left: 600px; top: 400px; background-color: white"></a>
        </section>

        <section>
          <h3><b>Performance</b></h3>
          <img src="asm_jun_10_2013.png">
          <p><small>(JS engines and Emscripten from June 10th 2013, run on a 64-bit linux machine)</small></p>
        </section>

        <section>
          <h3><b>Performance</b></h3>
          <p><ul>
            <li>JavaScript can be very close to native speed, about 1x-3x slower</li>
            <li>C/C++ compiled to JavaScript can outperform handwritten JavaScript, which is another possible motivation to compile to JavaScript</li>
          </ul></p>
        </section>

        <section>
          <h3><b>We can run other languages on the web, by running them in JavaScript</b></h3>
          <p>All modern web browsers have fast JavaScript engines and support for JavaScript typed arrays, which is exactly what we need for compiled code</p>
        </section>

        <section>
          <h3><b>Connecting Languages</b></h3>
          <p class="fragment">What do other platforms/environments do?</p>
        </section>

        <section>
          <h3><b>Embedding one language in another</b></h3>
          <p>Often there is a primary language, and a secondary language is <b>embedded</b> in it</p>
          <img src="languages.png" style="border: 0; box-shadow: none;">
          <p>Primary language sets up the secondary one</p>
          <p>Still possible to communicate both ways</p>
        </section>

        <section>
          <h3><b>Embedding APIs for C/C++</b></h3>
          <p>Embed Python, Lua, etc. into a C/C++ project, for use as a scripting language</p>
          <p>C APIs let you run code in the scripting language:</p>
          <pre><code contenteditable>  // C code
  PyRun_SimpleString("print 'hello from python!'");</code></pre>
          <p>Other APIs let you create Python objects and operate on them from C</p>
        </section>

        <section>
          <h3><b>Create C/C++ Modules</b></h3>
          <p>Access C/C++ code from Python, Lua, etc.</p>
          <pre><code contenteditable>  // C++ with Boost.Python
  #include "boost/python.hpp"
  char const* greet() {
    return "hello from C!";
  }
  BOOST_PYTHON_MODULE(greeter) {
    boost::python::def("greet", greet);
  }
</code></pre>
          <hr>
          <pre><code contenteditable>  # Python
  >>> import greeter
  >>> greeter.greet()
  hello from C!
</code></pre>
        </section>

        <section>
          <h3><b>Python => C++</b></h3>
          <p>Boost.Python can also wrap C++ classes for Python</p>
          <pre><code contenteditable>  // C++ class
  class Cat {
    string name;
  public:
    Cat(string name_) : name(name_) {}
    void meow() { printf("%d meows\n", name);
  };
  BOOST_PYTHON_MODULE(Cats) {
    class &lt;Cat&gt;("Cat").def("meow", &Cat::meow);
  }
</code></pre>
          <hr>
          <pre><code contenteditable>  // Python
  >>>> import Cats
  >>>> my_cat = Cats.Cat('Fluffy')
  >>>> print my_cat.meow()
  Fluffy meows
</code></pre>
        </section>

        <section>
          <h3><b>That's all well and good</b></h3>
          <p>Can we do this in <b>JavaScript</b>?</p>
          <h3 class="fragment"><b>yes!</b></h3>
        </section>

        <section>
          <h3><b>C => JavaScript</b></h3>
          <p>Emscripten provides APIs for this on the C side</p>
            <pre><code contenteditable>  #include "emscripten.h"
  int main() {
    // Call JS from C
    emscripten_run_script("alert('hello from C!')");
    return 0;
  }
</code></pre>
        </section>

        <section>
          <h3><b>C => JavaScript</b></h3>
          <p>Writing a C API in JS (emcc --js-library)</p>
            <pre><code contenteditable>  // JS library file
  mergeInto(LibraryManager.library, {
    js_func: function(x) { alert('you sent ' + x) }
  });
</code></pre>
          <hr>
          <pre><code contenteditable>  // C code
  extern "C" { void js_func(int x, int y); }
  int main() {
    js_func(3); // will cause alert(3)
    return 0;
  }
</code></pre>
        </section>

        <section>
          <h3><b>JavaScript => C</b></h3>
          <p>Emscripten provides APIs for this on the JS side too</p>
            <pre><code contenteditable>  // C file that was compiled to JS
  int c_add(int x, int y) { return x+y; }
</code></pre>
          <hr>
          <pre><code contenteditable>  // Call C from JS
  var result = ccall('c_add', // name
                     'number', // return type
                     ['number', 'number'], // argument types
                     [10, 20]); // arguments
  // returns 30
</code></pre>
        </section>

        <section>
          <h3><b>JavaScript => C</b></h3>
          <p><b>cwrap</b> is useful for multiple calls
          <pre><code contenteditable>  // Call C from JS
  var c_add = cwrap('c_add', // name
                    'number', // return type
                    ['number', 'number']); // argument types

  console.log(c_add(10, 20)); // 30
  console.log(c_add(20, 30)); // 50
</code></pre>
        <p>Wrapper behaves just like a normal JS function</p>
        </section>

        <section>
          <h3><b>C++ => JS</b></h3>
          <p><b>Embind</b>, written by IMVU, glues together C++ and JavaScript</p>
          <pre><code contenteditable>  // Access JS objects in C++ like C++ objects
  #include "emscripten/val.h"
  using namespace emscripten;
  int main() {
    val Math = val::global("Math");
    return Math.call<int>("abs", -10); // returns 10
  }
</code></pre>
        </section>

        <section>
          <h3><b>JS => C++</b></h3>
          <p>Embind can also go the other way</p>
          <pre><code contenteditable>  // C++ library
  #include "emscripten/bind.h"
  using namespace emscripten;
  int add (int a, int b) { return a+b; }
  EMSCRIPTEN_BINDINGS(my_module) {
      function("lerp", &lerp);
  }
</code></pre>
          <hr>
          <pre><code contenteditable>  // Use it in JS
  alert(Module.add(10, 20)); // shows 30
</code></pre>
        </section>

        <section>
          <h3><b>JS => C++</b></h3>
          <p>Embind can also wrap C++ classes for JS</p>
          <pre><code contenteditable>  // C++ class
  class Cat {
    string name;
  public:
    Cat(string name_) : name(name_) {}
    void meow() { printf("%d meows\n", name);
  };
  EMSCRIPTEN_BINDINGS(Cats) {
    class_&lt;Cat&tt;("Cat").constructor<std::string>()
                         .function("meow", &Cat::meow);
  }
</code></pre>
          <hr>
          <pre><code contenteditable>  // JavaScript
  var myCat = new Module.Cat("Fluffy");
  alert(myCat.meow()); // shows "Fluffy meows"
</code></pre>
          <p class="fragment">Very much like Boost.Python does for Python</p>
        </section>

        <section>
          <h3><b>Challenges</b></h3>
          <p>
            <ul>
              <li>No way to know when a JS object is garbage-collected. Must call <b>cat.delete()</b> to properly clean it up</li>
            </ul>
          </p>
        </section>

        <section>
          <h3><b>We can run other languages on the web, by running them in JavaScript</b></h3>
          <h3><b>and we can connect them to JavaScript</b></h3>
          <p>Very similar to what we saw earlier that other platforms can do</p>
          <p class="fragment">Now let's see some stuff that is specific to the web</p>
        </section>








        <!-- Lua scripting example -->

        <section>
          <h3><b>Lua scripting on the web</b></h3>
          <p>The time in milliseconds, reported by Lua:</p>
          <b><p id="lua_output">.</p></b>

          <script src="qcon_data/lua.vm.js"></script>
          <script type="text/lua">
          js.global.setInterval(function()
            js.global.document.getElementById('lua_output').innerHTML = js.global.Date.now()
          end, 1000)
          </script>

          <p class="fragment">View source if you don't believe ;)</p>
        </section>

        <!-- Lua scripting example -->








        <section>
          <h3><b>Lua JavaScript</b></h3>
          <p>Dual-repl example?</p>
        </section>

        <section>
          <h3><b>Summary</b></h3>
          <p class="fragment">We can use languages other than JavaScript on the web, by <b>compiling</b> them to JavaScript</p>
          <p class="fragment">Those languages can interact with JavaScript, allowing <b>mixed-language</b> projects</p>
          <p class="fragment">JavaScript VMs are, in effect, <b>multilanguage VMs</b></p>
        </section>

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: 'sky', //Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },

          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
