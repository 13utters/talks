<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>asm.js: Native Speed on the Web</title>

    <meta name="description" content="Native Speed on the Web: JavaScript and asm.js">
    <meta name="author" content="Alon Zakai">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/sky.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->

    <style type="text/css">
      h2 b {
        color: #048;
      }
      h3 b {
        color: #369;
      }
      b {
        color: #63a;
      }
      strong {
        color: #c11;
      }
      img {
        box-shadow: 10px 10px 10px rgba(0,0,0,0.5)
      }
    </style>

  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>
          <h2>Native Speed on the Web: JavaScript and asm.js</h2>
          <br>
          <h3>Alon Zakai (Mozilla logo)</h3>
          <p><a href="http://twitter.com/#!/kripken">@kripken</a></p>
        </section>

        <section>
          <h3><b>The Web</b></h3>
          <img src="browser-logos.png" style="border: 0; box-shadow: none;">
          <br>
          <p class="fragment">Biggest open and standards-based platform</p>
          <p class="fragment">Best way to reach users</p>
          html5 logo, w3c, etc.
        </section>

        <section>
          <h3><b>How fast is it?</b></h3>
          <br>
          <div class="fragment">
            <img src="website_slow.jpg">
          </div>
        </section>

        <section>
          <h3><b>Speed on the Web</b></h3>
          <p class="fragment">Speed is determined by many things</p>
          <p class="fragment">DOM, graphics, JavaScript</p>
          <p class="fragment">This talk is mainly about JavaScript</p>
        </section>

        <section>
          <h3><b>How fast is JavaScript?</b></h3>
          <p class="fragment">The <b><a href="epic/EpicCitadel.html">Epic Citadel demo</a></b> is one way to measure that</p>
          <p class="fragment">Over 1 million lines of C++ compiled to JavaScript using <a href="http://emscripten.org">Emscripten</a></p>
          <p class="fragment">OpenGL renderer, compiled to use WebGL</p>
        </section>

        <section>
          <h3><b>Epic Citadel: Progress</b></h3>
          <p class="fragment">You may have seen the demo when it launched, 6 months ago (March 2013)</p>
          <p class="fragment">The demo itself hasn't changed much since - but browsers have:</p>
          <p class="fragment">Back then it only ran in Firefox, today it also runs in Chrome</p>
          <p class="fragment">Back then it took 20 seconds to start up, today it takes 10 seconds</p>
          <p class="fragment">Back then it ran at 40fps, today both Firefox and Chrome run at 60fps</p>
        </section>

        <section>
          <h3><b>JavaScript Naysaying / Time</b></h3>
          <p class="fragment">"JS is 100x slower than native code" (and it was, when it was just interpreted)</p>
          <p class="fragment">"JS is 10x slower than native code" (and it was, when it was first JIT compiled)</p>
          <p class="fragment">Today JS engines have sophisticated type-specializing JITs and are much faster, and critics say "any amount of slowdown compared to native is bad" (and that's true too)</p>
        </section>

        <section>
          <h3><b>Current Performance</b></h3>
          <a href="benchmarks_sep_6_2013.png"><img src="benchmarks_sep_6_2013.png"></img></a>
          <br>
          <p><small>Emscripten benchmark suite (VMs and Emscripten from Sep 6 2013, run on 64-bit linux)</small></p>
        </section>

        <section>
          <h3><b>asm.js</b></h3>
          <p class="fragment">Those numbers are on <b>asm.js</b>, a subset of JavaScript that is easy to optimize</p>
          <p class="fragment">Benchmarks we just saw show both Firefox and Chrome run between 1-3 times slower than native</p>
          <hr class="fragment">
          <pre class="fragment"><code contenteditable>  function asmCode(global, env, buffer) {
    'use asm';
    var HEAP = new global.Uint8Array(buffer);
    function fib_like(x) {
      x = x|0;
      if ((x >>> 0) < 2) return HEAP[x]|0;
      return ((fib_like((x-2)|0)|0) + (fib_like((x-1)|0)|0))|0;
    }
    return fib_like;
  }</code></pre>
          <hr class="fragment">
          <p class="fragment">HEAP cannot be replaced</p>
          <p class="fragment">|0 trick ensures 32-bit ints</p>
        </section>

        <section>
          <h3><b>asm.js - Background</b></h3>
          <p class="fragment">Began as a research project at Mozilla</p>
          <p class="fragment">Every compiler (CoffeeScript, Google Web Toolkit, etc.) generates a particular
                              pattern of JS</p>
          <p class="fragment">Emscripten and Mandreel compiled C++ to JS into a particular pattern as well</p>
          <p class="fragment">asm.js is a formal definition of that pattern, with some improvements</p>
        </section>

        <section>
          <h3><b>asm.js comparison</b></h3>
          <p class="fragment">asm.js is <strong>faster</strong> than "typical" JavaScript on Internet Explorer, Chrome and Firefox</p>
          <br>
          <p class="fragment">Box2D results</p>
          <a class="fragment href="box2d_graph_updated2.png"><img src="box2d_graph_updated2.png" style=""></a>
          <p class="fragment"><small>source: <a href="https://twitter.com/jgw">@jgw</a>, <a href="http://j15r.com/blog/2013/07/05/Box2d_Addendum">Box2D Addendum</a>; lower is better</small></p>
          <br>
          <p class="fragment">Box2dWeb: Port of Box2D using "typical" JS<br>asm.js: Port of Box2D using asm.js</p>
          <p class="fragment">Note also that asm.js on Firefox and Chrome is comparable to Java</p>
        </section>

        <section>
          <h3><b>Box2D: Progress and AOT</b></h3>
          <a href="asmprogress2.png"><img src="asmprogress2.png"></a>
          <p><small>source: <a href="http://arewefastyet.com/#machine=12&view=breakdown&suite=asmjs-apps">arewefastyet.com</a>; x axis is time, y axis is milliseconds (lower is better)</small></p>
          <p class="fragment">Red/orange is Ahead Of Time (AOT) compilation (using the asm.js type system)</p>
          <p class="fragment">Just In Time (JIT) compilers catching up fast</p>
          <p class="fragment">AOT is not necessary, but makes optimization easier and prevents recompilation overhead</p>
          <p class="fragment">No point in time where asm.js is "supported" by a browser, asm.js is just a subset of JS that is being optimized like any other</p>
        </section>

        <section>
          <h3><b>But I use Safari or IE..?</b></h3>
          <p class="fragment">I've been talking about Firefox and Chrome, but Safari and Internet Explorer are important too of course!</p>
        </section>

        <section>
          <h3><b>Some Safari Numbers</b></h3>
          <a href="micro_w_s.png"><img src="micro_w_s.png"></a>
          <br>
          <p class="fragment">Very close on some, farther on others</p>
          <p class="fragment">Not standing still: Experimenting with using <a href="https://bugs.webkit.org/show_bug.cgi?id=112840">LLVM as a JIT</a></p>
        </section>

        <section>
          <h3><b>Internet Explorer</b></h3>
          <p class="fragment">IE11, currently in pre-release builds, looks promising</p>
          <p class="fragment">Too early to benchmark, but I've seen it beat Chrome and Firefox in some JS tests</p>
          <p class="fragment">Supports WebGL!</p>
        </section>

        <section>
          <h3><b>Safari and IE</b></h3>
          <p class="fragment">All browsers, including those, support JavaScript and optimize it</p>
          <p class="fragment">Only question is how fast and how soon</p>
        </section>

        <section>
          <h3><b>Big Picture</b></h3>
          <p class="fragment">Overall JS speed is good and getting better</p>
          <p class="fragment">Half the speed of native in many cases</p>
          <p class="fragment">What are the remaining issues?</p>
        </section>

        <section>
          <h3><b>1. 32-bit Floats</b></h3>
          <p class="fragment">JavaScript numbers are 64-bit doubles</p>
          <p class="fragment">Often take more CPU cycles to compute</p>
          <p class="fragment">Require more memory bandwidth</p>
        </section>

        <section>
          <h3><b>32-bit Floats</b></h3>
          <p class="fragment">Sometimes possible to do 32-bit math on 64-bit values as an optimization</p>
          <pre class="fragment"><code contenteditable>  var floats = new Float32Array(calc());
  floats[0] = floats[1] + floats[2];
  floats[1] = floats[0] + floats[2];
  floats[2] = floats[1] + floats[2];
</code></pre>
          <p class="fragment">Mathematically provable that those additions can be 32-bit</p>
          <p class="fragment">So no reason JS engines cannot do this right now, and Firefox is <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=888109">working on it</a></p>
        </section>

        <section>
          <h3><b>32-bit Floats</b></h3>
          <p class="fragment">More general code fails though</p>
          <pre class="fragment"><code contenteditable>  var floats = new Float32Array(calc());
  floats[0] = floats[1] + floats[2] + 1;
  floats[1] = floats[0] + floats[2] + 1;
  floats[2] = floats[1] + floats[2] + 1;
</code></pre>
          <p class="fragment"><b>+1</b> prevents the optimization</p>
          <p class="fragment">But ES6 (proposal for the next version of JS) includes <b>Math.fround</b>,
                              which rounds to 32-bit precision</p>
          <pre class="fragment"><code contenteditable>  var floats = new Float32Array(calc());
  floats[0] = Math.fround(floats[1] + floats[2]) + 1;
  floats[1] = Math.fround(floats[0] + floats[2]) + 1;
  floats[2] = Math.fround(floats[1] + floats[2]) + 1;
</code></pre>
          <p class="fragment">Now optimizable!</p>
          <p class="fragment">Preliminary tests on Firefox show 10-20% speedups on relevant code</p>
        </section>

        <section>
          <h3><b>2. SIMD</b></h3>
          <p class="fragment">CPUs have hardware support for SSE etc. which can make certain types of code much faster</p>
          <p class="fragment">C++ has various ways to support it, and some VMs do as well: Mono, Dart</p>
          <p class="fragment">John McCutchan from Google wrote a <a href="https://github.com/johnmccutchan/ecmascript_simd">proposal for SIMD in JS</a></p>
        </section>

        <section>
          <h3><b>SIMD</b></h3>
          <pre class="fragment"><code contenteditable>  var x = new float32x4(1, 2, 3.14159, 22.5);
  var y = new float32x4(0, 0, 1, 0);
  var z = x.add(y);
</code></pre>
          <p class="fragment">Immutable 128-bit values</p>
          <p class="fragment">Relatively straightforward design, based on John's experience doing the same in Dart</p>
          <p class="fragment">Potentially big (e.g. 300% in some cases) speedups on certain types of code</p>
          <p class="fragment">Collaboration is ongoing with Mozilla, Intel and others</p>
        </section>

        <section>
          <h3><b>3. Threads</b></h3>
          <p class="fragment">Web workers allow multiple CPU cores to be utilized</p>
          <p class="fragment">Web workers can transfer typed arrays, avoiding copies</p>
          <p class="fragment">But they can't read and write to the same data at once</p>
          <p class="fragment">Good for preventing data races, but bad for some types of projects, for example
                              modern game engines are heavily multithreaded</p>
        </section>

        <section>
          <h3><b>Threads</b></h3>
          <p class="fragment">Various proposals exist for allowing more parallel computation on data, but no clear direction yet</p>
          <p class="fragment">Would require all vendors to agree and standardize something new and complex</p>
          <p class="fragment">Part of the challenge is figuring out how it fits in with the rest of the web, which does not currently have data races at all</p>
          <p class="fragment">For example it would be technically simple to allow workers access to a shared typed array, but many feel this goes against
                              the JS programming model</p>
        </section>

        <section>
          <h3><b>Pre-Summary</b></h3>
          <p class="fragment">JS is getting close to native speed, even if some hurdles remain</p>
          <p class="fragment">But important to remember that the web is better than other platforms in many ways</p>
          <p class="fragment">Size and reach</p>
          <p class="fragment">Ability to combine content in interesting ways: [final demo]</p>
        </section>

        <section>
          <h3><b>What you just saw</b></h3>
          <p class="fragment">BananaBread, a port of the Cube 2/Sauerbraten First Person Shooter (FPS) to JS+WebGL</p>
          <p class="fragment">Boon, a fully open source FPS based on the Doom source code (PrBoom) + free art assets (Freedoom)</p>
          <p class="fragment">Boon runs in a web worker, input events are proxied to it, output of software renderer is sent back</p>
          <p class="fragment">We push those pixels to a WebGL texture</p>
          <p class="fragment">Less than <a href="miniBoon.js">100 lines of code</a> to integrate the two</p>
          <p class="fragment">Easily 60fps on an average laptop with an Intel GPU and Linux - not a hot rod!</p>
        </section>

        <section>
          <h3><b>Summary</b></h3>
          <p class="fragment">TODO</p>
          <div class="fragment">
            <hr>
            <p><b style="color: #c11">That's it! Questions?</b></p>
          </div>
        </section>
        </section>

<!--

The 2x figure is on asm.js code:
 * Types never changing is a strict requirement; you want a compiler to generate this code, usually
   * can use asm.js for speed-intensive stuff like physics, JS for the rest
     * bullet [demo] with 500 boxes etc
-->

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: 'sky', //Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },

          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
